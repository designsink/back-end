name: Deploy to dsink

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle (skip tests)
      run: ./gradlew build -x test

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: DB_URL,DB_USERNAME,DB_PASSWORD,JWT_SECRET_KEY,FILE_UPLOAD
        script: |
          cd ~/app

          # uploads ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p uploads

          # 8080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì •ë¦¬
          echo "ğŸ” Checking processes using port 8080..."
          sudo netstat -tlnp | grep :8080 || echo "No processes found on port 8080"

          # 8080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ì»¨í…Œì´ë„ˆë“¤ ê°•ì œ ì¢…ë£Œ
          echo "ğŸ›‘ Stopping containers using port 8080..."
          docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Ports}}" | grep 8080 | awk '{print $1}' | xargs -r docker stop
          docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Ports}}" | grep 8080 | awk '{print $1}' | xargs -r docker rm

          # ê¸°ì¡´ dsink-app ì»¨í…Œì´ë„ˆ ì™„ì „ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up existing dsink-app containers..."
          docker stop dsink-app || true
          docker rm dsink-app || true

          # ì ì‹œ ëŒ€ê¸° (í¬íŠ¸ í•´ì œ ëŒ€ê¸°)
          echo "â³ Waiting for port to be released..."
          sleep 5

          # ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±°
          echo "ğŸ—‘ï¸ Removing old images..."
          docker rmi dsink-app:latest || true

          # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ğŸ”¨ Building new image..."
          docker build -t dsink-app:latest .

          # ë¹Œë“œ ì„±ê³µ í™•ì¸
          if [ $? -ne 0 ]; then
              echo "âŒ Docker build failed!"
              exit 1
          fi

          # í¬íŠ¸ ì‚¬ìš© ì¬í™•ì¸
          if netstat -tlnp | grep :8080; then
              echo "âŒ Port 8080 is still in use. Please check manually."
              netstat -tlnp | grep :8080
              exit 1
          fi

          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name dsink-app \
            -p 8080:8080 \
            -v ~/app/uploads:/app/uploads \
            -e DB_URL="$DB_URL" \
            -e DB_USERNAME="$DB_USERNAME" \
            -e DB_PASSWORD="$DB_PASSWORD" \
            -e JWT_SECRET_KEY="$JWT_SECRET_KEY" \
            -e FILE_UPLOAD="$FILE_UPLOAD" \
            --restart unless-stopped \
            dsink-app:latest

          # ì»¨í…Œì´ë„ˆ ì‹œì‘ í™•ì¸
          if [ $? -ne 0 ]; then
              echo "âŒ Failed to start container!"
              docker logs dsink-app --tail=20
              exit 1
          fi

          echo "â³ Waiting for application to start..."
          sleep 30

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          docker ps | grep dsink-app
          if [ $? -ne 0 ]; then
              echo "âŒ Container is not running!"
              docker logs dsink-app --tail=50
              exit 1
          fi

          # í—¬ìŠ¤ì²´í¬ (ì¬ì‹œë„ ë¡œì§ ê°œì„ )
          echo "ğŸ©º Starting health check..."
          for i in {1..15}; do
              echo "Health check attempt $i/15..."
              
              # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ ë¨¼ì € í™•ì¸
              if ! docker ps | grep -q dsink-app; then
                  echo "âŒ Container stopped unexpectedly!"
                  docker logs dsink-app --tail=50
                  exit 1
              fi
              
              # í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰
              if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                  echo "âœ… Health check passed!"
                  curl http://localhost:8080/actuator/health
                  break
              else
                  echo "â³ Health check failed, attempt $i/15"
                  if [ $i -eq 15 ]; then
                      echo "âŒ Health check failed after 15 attempts"
                      echo "ğŸ“‹ Container logs:"
                      docker logs dsink-app --tail=50
                      echo "ğŸ“‹ Container status:"
                      docker ps -a | grep dsink-app
                      exit 1
                  fi
                  sleep 10
              fi
          done

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up unused images..."
          docker image prune -f

          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Container status:"
          docker ps | grep dsink-app
      env:
        DB_URL: ${{ secrets.DB_URL }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        FILE_UPLOAD: ${{ secrets.FILE_UPLOAD }}
